<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PersonaTalk â€“ JS (No-CDN, GH Pages Ready)</title>
  <!-- è¯´æ˜ï¼šä¸ºè§£å†³ â€œScript errorâ€ (å¸¸è§äº CDN/CSP é˜»æ‹¦) ï¼Œæœ¬ç‰ˆæœ¬å½»åº•å»é™¤å¤–éƒ¨ä¾èµ–ä¸å†…è”æ¨¡å—åŠ è½½ï¼Œ
       ä»…ä½¿ç”¨åŸç”Ÿ JS å®ç°åŒæ ·çš„äº¤äº’ä¸æµ‹è¯•ç”¨ä¾‹ã€‚å¯ç›´æ¥ä½œä¸º GitHub Pages çš„ index.html ä½¿ç”¨ã€‚ -->
  <style>
    :root{--border:#e5e7eb;--blue:#2563eb;--bg:#f5f7fb;--text:#111827}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto;color:var(--text);background:var(--bg)}
    header,main,footer{max-width:1000px;margin:0 auto;padding:12px 16px}
    .title{font-size:18px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:12px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card-title{font-weight:600;margin-bottom:8px;font-size:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:999px;cursor:pointer}
    .chip.active{border-color:var(--blue);background:#eff6ff}
    .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .btn.primary{background:var(--blue);color:#fff;border:none}
    .tests{margin:8px 0 0 18px;font-size:12px}
    .tests .pass{color:#059669}.tests .fail{color:#dc2626}
    .chatbox{height:52vh;overflow:auto;padding-right:4px}
    .bubble{max-width:80%;padding:10px 12px;border-radius:12px;margin:6px 0;white-space:pre-wrap}
    .bubble.user{margin-left:auto;background:var(--blue);color:#fff}
    .bubble.ai{margin-right:auto;background:#fff;border:1px solid var(--border)}
    .by{opacity:.7;font-size:11px;margin-bottom:4px}
    .skills{margin:6px 0 8px 0;border-top:1px solid var(--border);padding-top:6px;font-size:12px}
    .block{margin-top:6px}.block-title{font-weight:600;margin-bottom:2px}
    .composer{display:flex;gap:8px;margin-top:8px}
    .composer textarea{flex:1;min-height:48px;border:1px solid var(--border);border-radius:10px;padding:8px}
    .empty{font-size:12px;color:#9ca3af}
    .meta{font-size:12px;color:#667085}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">ğŸ§­ PersonaTalk â€“ JS MVPï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰</div>
      <div class="meta">ä¸ºé¿å… CDN/CSP è§¦å‘çš„ â€œScript errorâ€ï¼Œæœ¬é¡µå®Œå…¨ä½¿ç”¨åŸç”Ÿ JSã€‚æœªæ¥æ¥å…¥çœŸå® LLM/ASR/TTS æ—¶ï¼Œå¯æŒ‰éœ€æ›¿æ¢ mockReply/å‘é€é€»è¾‘ã€‚</div>
    </header>

    <main class="grid">
      <!-- å·¦ä¾§ï¼šè®¾ç½® / æµ‹è¯• -->
      <section>
        <div class="card">
          <div class="card-title">è®¾ç½®</div>
          <div class="meta">è§’è‰²</div>
          <div id="chips" class="chips" style="margin-top:6px"></div>
          <div id="styleMeta" class="meta" style="margin-top:6px"></div>
          <!-- æœªæ¥å¯åœ¨æ­¤å¤„æ·»åŠ  Provider/API Key/ASR/TTS çš„è®¾ç½®è¡¨å•ï¼ˆæœ¬ç‰ˆä¸è”ç½‘ã€ä¸å¤–é“¾ï¼‰ -->
        </div>

        <div class="card">
          <div class="card-title">æµ‹è¯•ç”¨ä¾‹ (Mock)</div>
          <button id="runTests" class="btn">è¿è¡Œæµ‹è¯•</button>
          <ul id="tests" class="tests"></ul>
        </div>
      </section>

      <!-- å³ä¾§ï¼šèŠå¤© -->
      <section>
        <div class="card">
          <div id="chatTitle" class="card-title"></div>
          <div id="chatbox" class="chatbox"></div>
          <div class="composer">
            <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯â€¦"></textarea>
            <button id="send" class="btn primary">å‘é€</button>
          </div>
        </div>
      </section>
    </main>

    <footer class="meta" style="text-align:center">PersonaTalk Â© 2025 Â· JS ç‰ˆï¼ˆGH Pages å‹å¥½ï¼Œé›¶å¤–éƒ¨ä¾èµ–ï¼‰ã€‚</footer>
  </div>

  <script>
  (function(){
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // çŠ¶æ€ & é¢„è®¾
    var state = {
      role: 'harry',
      messages: [], // {role:'user'|'assistant', content, skills?}
      presets: {
        harry:   { id:'harry',   name:'å“ˆåˆ©Â·æ³¢ç‰¹', avatar:'ğŸª„', style:'æ¸©æš–ã€å‹‡æ•¢ã€å°‘å¹´å£å»ï¼›ä¸å¼•ç”¨å—ç‰ˆæƒä¿æŠ¤çš„åŸæ–‡å°è¯ã€‚', extraKey:'script' },
        socrates:{ id:'socrates', name:'è‹æ ¼æ‹‰åº•',   avatar:'ğŸ›ï¸', style:'ç®€æ´åè¯˜ï¼Œå±‚å±‚è¿½é—®ï¼Œå¸®åŠ©æ¾„æ¸…è§‚ç‚¹ã€‚',               extraKey:'rebuttal_tree' },
        sherlock:{ id:'sherlock', name:'ç¦å°”æ‘©æ–¯',   avatar:'ğŸ•µï¸â€â™‚ï¸', style:'å†·é™ã€è§‚å¯Ÿå…¥å¾®ã€é€»è¾‘ä¸¥è°¨ï¼Œè¾“å‡ºå¯éªŒè¯çº¿ç´¢ã€‚',         extraKey:'clues' }
      }
    };

    // DOM ç¼“å­˜
    var el = {
      chips: document.getElementById('chips'),
      styleMeta: document.getElementById('styleMeta'),
      chatTitle: document.getElementById('chatTitle'),
      chatbox: document.getElementById('chatbox'),
      input: document.getElementById('input'),
      send: document.getElementById('send'),
      runTests: document.getElementById('runTests'),
      tests: document.getElementById('tests')
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ä¸šåŠ¡é€»è¾‘
    function mockReply(role, text){
      var base = {
        bullets: ['å‘éŸ³/ç”¨è¯å»ºè®®ï¼šä¼˜å…ˆæ¸…æ™°ä¸ç®€æ´','å¤è¿°ç¤ºèŒƒï¼šå°è¯•ç”¨æ›´è‡ªç„¶çš„è¡¨è¾¾'],
        action_items: ['ä¸‹ä¸€æ­¥ï¼šç”¨ä¸‰å¥è¯å¤è¿°è§‚ç‚¹','æå‡ºä¸€ä¸ªåé—®é¢˜'],
        key_terms: ['å…³é”®è¯ç¤ºä¾‹A','å…³é”®è¯ç¤ºä¾‹B']
      };
      if(role==='harry'){
        return {
          text: 'ã€å“ˆåˆ©Â·æ³¢ç‰¹ã€‘æ”¶åˆ°ï¼š' + text + '\n' + 'å‹‡æ•¢ç‚¹ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ã€‚ç»™ä½ ä¸€ä¸ªå°ç‰‡æ®µ~',
          skills: assign({}, base, { extra:{ script:'ã€èµ°å»Šã€‘â€œæˆ‘ä»¬å¾—å¿«ç‚¹ï¼â€â€”â€”â€œåˆ«æ…Œï¼Œå…ˆæ‰¾çº¿ç´¢ã€‚â€' } })
        };
      }
      if(role==='socrates'){
        return {
          text: 'ã€è‹æ ¼æ‹‰åº•ã€‘å…³äºã€Œ' + text + 'ã€ï¼Œå…ˆæ€è€ƒä¸‰ä¸ªé—®é¢˜ï¼šä½ ä¸ºä½•å¦‚æ­¤è®¤ä¸ºï¼Ÿè‹¥ç›¸åæ˜¯å¦æˆç«‹ï¼Ÿä½ ä½¿ç”¨çš„å®šä¹‰æ˜¯å¦ä¸€è‡´ï¼Ÿ',
          skills: assign({}, base, { extra:{ rebuttal_tree:['ä½ ä¸ºä½•å¦‚æ­¤è®¤ä¸ºï¼Ÿ','è‹¥ç›¸åè§‚ç‚¹æˆç«‹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ','ä½ æ‰€ç”¨çš„å®šä¹‰æ˜¯å¦ä¸€è‡´ï¼Ÿ'] } })
        };
      }
      if(role==='sherlock'){
        return {
          text: 'ã€ç¦å°”æ‘©æ–¯ã€‘åˆ†æã€Œ' + text + 'ã€ã€‚æˆ‘ä¼šåˆ—å‡ºçº¿ç´¢å¹¶æå‡ºå¯éªŒè¯çš„å‡è®¾ã€‚',
          skills: assign({}, base, { extra:{ clues:[{fact:'é—¨æŠŠæ‰‹ä¸Šæœ‰æ³¥ç‚¹', hypo:'æ¥è®¿è€…åˆšä»åé™¢è¿›å…¥'},{fact:'è„šå°æ–¹å‘ç›¸å', hypo:'ç¦»å¼€ä¸è¿›å…¥ä¸åŒæ­¥'}] } })
        };
      }
      return { text: 'æ”¶åˆ°ï¼š' + text, skills: base };
    }

    function sendText(t){
      var text = (t==null? "": String(t)).trim();
      if(!text) return false; // ç©ºè¾“å…¥ä¸å‘é€
      state.messages.push({ role:'user', content:text });
      var res = mockReply(state.role, text);
      state.messages.push({ role:'assistant', content:res.text, skills:res.skills });
      renderMessages();
      return true;
    }

    function switchRole(role){
      if(!state.presets[role]) return;
      state.role = role;
      renderHeader();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æ¸²æŸ“
    function renderHeader(){
      var p = state.presets[state.role];
      // æ¸²æŸ“è§’è‰² chips
      var chipsHtml = Object.keys(state.presets).map(function(key){
        var it = state.presets[key];
        return '<button data-role="' + it.id + '" class="chip ' + (state.role===it.id? 'active':'') + '">' + it.avatar + ' ' + it.name + '</button>';
      }).join('');
      el.chips.innerHTML = chipsHtml;
      // é£æ ¼
      el.styleMeta.textContent = 'é£æ ¼ï¼š' + p.style;
      // èŠå¤©æ ‡é¢˜
      el.chatTitle.textContent = p.avatar + ' ' + p.name;
    }

    function renderMessages(){
      if(!state.messages.length){
        el.chatbox.innerHTML = '<div class="empty">å¼€å§‹å¯¹è¯å§ï¼šä¾‹å¦‚è¾“å…¥â€œå¸®æˆ‘åšå£è¯­çº é”™â€æˆ–â€œç»™æˆ‘è¦ç‚¹æ€»ç»“â€ã€‚</div>';
        return;
      }
      var html = '';
      for(var i=0;i<state.messages.length;i++){
        var m = state.messages[i];
        var name = (m.role==='user')? 'ä½ ' : state.presets[state.role].name;
        var head = '<div class="bubble ' + (m.role==='user'?'user':'ai') + '">' +
                   '<div class="by">' + name + '</div>' +
                   '<pre class="content">' + escapeHtml(m.content) + '</pre>' +
                   '</div>';
        var block = '';
        if(m.skills){
          var s = m.skills || {}; var ex = s.extra || {};
          block += '<div class="skills">';
          if(s.bullets && s.bullets.length){
            block += '<div class="block"><div class="block-title">â€¢ è¦ç‚¹</div><ul>' + s.bullets.map(li).join('') + '</ul></div>';
          }
          if(s.action_items && s.action_items.length){
            block += '<div class="block"><div class="block-title">â€¢ ä¸‹ä¸€æ­¥</div><ul>' + s.action_items.map(li).join('') + '</ul></div>';
          }
          if(s.key_terms && s.key_terms.length){
            block += '<div class="block"><span class="block-title">â€¢ å…³é”®è¯ï¼š</span>' + s.key_terms.map(escapeHtml).join(', ') + '</div>';
          }
          if(ex.script){ block += '<div class="block"><span class="block-title">â€¢ å°å‰§æœ¬ï¼š</span>' + escapeHtml(ex.script) + '</div>'; }
          if(Array.isArray(ex.clues) && ex.clues.length){
            block += '<div class="block"><div class="block-title">â€¢ çº¿ç´¢æ¿ï¼š</div><ul>' + ex.clues.map(function(c){
              return '<li><b>äº‹å®</b> ' + escapeHtml(c.fact) + ' â†’ <b>å‡è®¾</b> ' + escapeHtml(c.hypo) + '</li>';
            }).join('') + '</ul></div>';
          }
          if(Array.isArray(ex.rebuttal_tree) && ex.rebuttal_tree.length){
            block += '<div class="block"><div class="block-title">â€¢ åè¯˜é—®é¢˜æ ‘ï¼š</div><ul>' + ex.rebuttal_tree.map(li).join('') + '</ul></div>';
          }
          block += '</div>';
        }
        html += '<div>' + head + (m.skills? block: '') + '</div>';
      }
      el.chatbox.innerHTML = html;
      el.chatbox.scrollTop = el.chatbox.scrollHeight;
    }

    function renderAll(){
      renderHeader();
      renderMessages();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // å·¥å…·å‡½æ•°
    function assign(target){
      for(var i=1;i<arguments.length;i++){
        var src = arguments[i] || {};
        for(var k in src){ if(Object.prototype.hasOwnProperty.call(src,k)){ target[k] = src[k]; } }
      }
      return target;
    }
    function escapeHtml(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function li(t){ return '<li>' + escapeHtml(t) + '</li>'; }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // äº‹ä»¶ç»‘å®š
    el.chips.addEventListener('click', function(e){
      var role = e.target && e.target.getAttribute('data-role');
      if(role){ switchRole(role); }
    });
    el.send.addEventListener('click', function(){
      var ok = sendText(el.input.value);
      if(ok) el.input.value = '';
    });
    el.input.addEventListener('keydown', function(e){
      if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
        var ok = sendText(el.input.value);
        if(ok) el.input.value = '';
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // æµ‹è¯•ï¼ˆä¿ç•™æ—¢æœ‰ 6 æ¡ï¼Œå†æ–°å¢ 3 æ¡ï¼‰
    function runTests(){
      var cases = [
        // ç°æœ‰è¯­ä¹‰ä¸€è‡´çš„ 6 æ¡
        { name:'Harry returns script', run:function(){ var r=mockReply('harry','t'); return r.skills && r.skills.extra && !!r.skills.extra.script; } },
        { name:'Socrates returns rebuttal tree', run:function(){ var r=mockReply('socrates','t'); return r.skills && r.skills.extra && Array.isArray(r.skills.extra.rebuttal_tree); } },
        { name:'Sherlock returns clues', run:function(){ var r=mockReply('sherlock','t'); return r.skills && r.skills.extra && Array.isArray(r.skills.extra.clues) && r.skills.extra.clues.length>0; } },
        { name:'Common fields present', run:function(){ var r=mockReply(state.role,'t'); return Array.isArray(r.skills && r.skills.bullets) && Array.isArray(r.skills && r.skills.action_items) && Array.isArray(r.skills && r.skills.key_terms); } },
        { name:'Presets length = 3', run:function(){ return Object.keys(state.presets).length===3; } },
        { name:'Mock fallback returns base', run:function(){ var r=mockReply('unknown','x'); return Array.isArray(r.skills && r.skills.bullets) && r.text.indexOf('æ”¶åˆ°')===0; } },
        // æ–°å¢ 3 æ¡
        { name:'Send adds user & assistant', run:function(){ var baseLen=state.messages.length; sendText('hi'); return state.messages.length===baseLen+2 && state.messages[baseLen].role==='user' && state.messages[baseLen+1].role==='assistant'; } },
        { name:'Empty input ignored', run:function(){ var before=state.messages.length; sendText('   '); return state.messages.length===before; } },
        { name:'Switch role updates title', run:function(){ switchRole('socrates'); return /è‹æ ¼æ‹‰åº•/.test(el.chatTitle.textContent || ''); } }
      ];
      var results = cases.map(function(c){ return { name:c.name, pass:!!c.run() }; });
      el.tests.innerHTML = results.map(function(r){ return '<li class="' + (r.pass?'pass':'fail') + '\">' + (r.pass?'âœ”':'âœ˜') + ' ' + r.name + '</li>'; }).join('');
      return results;
    }

    el.runTests.addEventListener('click', runTests);

    // åˆå§‹æ¸²æŸ“
    renderAll();

    // å°†å°‘é‡æ–¹æ³•æš´éœ²ç»™ windowï¼Œä¾¿äºåç»­æ¥ LL M/ASR/TTS æˆ–è°ƒè¯•
    window.__app = {
      state: state,
      mockReply: mockReply,
      sendText: sendText,
      switchRole: switchRole,
      runTests: runTests
    };
  })();
  </script>
</body>
</html>
